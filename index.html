<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>달의 모양 관찰하기</title>
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .moon-image {
            width: 200px;
            height: 200px;
            background-size: contain;
            background-repeat: no-repeat;
            margin: 0 auto 15px auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>달의 모양 관찰하기</h1>
    <input type="date" id="dateSelector">
    <div class="moon-display">
        <div id="moonImage" class="moon-image"></div>
        <h2 id="phaseText"></h2>
        <p id="moonMeaning"></p>
        <p id="moonKasiText"></p>
        <div id="moonTimes"></div>
        <div id="moonPosition"></div>
    </div>
</div>
<script>
function getMoonImageName(phase) {
    if (phase < 1) return "new_moon";
    if (phase < 15) return "waxing_crescent";
    if (phase < 35) return "first_quarter";
    if (phase < 45) return "waxing_gibbous";
    if (phase < 55) return "full_moon";
    if (phase < 65) return "waning_gibbous";
    if (phase < 85) return "last_quarter";
    if (phase < 99) return "waning_crescent";
    return "new_moon";
}

function getMoonPhaseMeaning(phase) {
    if (phase < 1) return ["삭 (New Moon) 🌑", "달이 완전히 가려져 보이지 않습니다. 새로운 시작을 준비해보세요."];
    if (phase < 15) return ["초승달 🌒", "새로운 아이디어와 시작에 적합한 시기입니다."];
    if (phase < 35) return ["상현달 🌓", "성장의 과정 속에서 균형을 되찾는 시기입니다."];
    if (phase < 45) return ["만상 🌔", "보름달을 향해 가는 완성의 길목입니다."];
    if (phase < 55) return ["보름달 🌕", "가장 밝은 시기입니다. 감사와 성찰의 시간입니다."];
    if (phase < 65) return ["기울어가는 만상 🌖", "이루어진 것을 정리하고 나눌 시기입니다."];
    if (phase < 85) return ["하현달 🌗", "반성하고 내려놓는 시간이 필요합니다."];
    if (phase < 99) return ["그믐달 🌘", "끝을 준비하고 새로운 순환을 위한 쉼의 시기입니다."];
    return ["삭 (New Moon) 🌑", "달이 완전히 가려져 보이지 않습니다."];
}

let currentLocation = null;
function updateUI(date) {
    const moon = SunCalc.getMoonIllumination(date);
    const phase = moon.phase * 100;
    const [name, meaning] = getMoonPhaseMeaning(phase);
    const imageName = getMoonImageName(phase);

    document.getElementById('moonImage').style.backgroundImage = `url('images/${imageName}.png')`;
    document.getElementById('phaseText').textContent = name;
    document.getElementById('moonMeaning').textContent = meaning;

    // 한국천문연구원 API 연동 예시
    fetch(`https://astro.kasi.re.kr/api/moon?date=${date.toISOString().slice(0,10)}&lat=${currentLocation?.latitude}&lon=${currentLocation?.longitude}`)
        .then(res => res.json())
        .then(data => {
            if (data) {
                document.getElementById('moonKasiText').textContent = `KASI 위상: ${data.phase} (${data.phase_name})`;
            }
        })
        .catch(() => {
            document.getElementById('moonKasiText').textContent = "KASI 데이터를 불러올 수 없습니다.";
        });

    if (currentLocation) {
        const moonTimes = SunCalc.getMoonTimes(date, currentLocation.latitude, currentLocation.longitude);
        const moonPos = SunCalc.getMoonPosition(date, currentLocation.latitude, currentLocation.longitude);
        document.getElementById('moonTimes').textContent = `출: ${moonTimes.rise?.toLocaleTimeString() || 'N/A'}, 몰: ${moonTimes.set?.toLocaleTimeString() || 'N/A'}`;
        document.getElementById('moonPosition').textContent = `고도: ${(moonPos.altitude * 180 / Math.PI).toFixed(1)}°, 방위각: ${(moonPos.azimuth * 180 / Math.PI).toFixed(1)}°`;
    }
}

document.getElementById('dateSelector').valueAsDate = new Date();
document.getElementById('dateSelector').addEventListener('change', (e) => {
    updateUI(new Date(e.target.value));
});

navigator.geolocation.getCurrentPosition(pos => {
    currentLocation = {
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
    };
    updateUI(new Date());
}, () => {
    document.getElementById('moonPosition').textContent = '위치 정보를 가져올 수 없습니다.';
});
</script>
</body>
</html>
