<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬ì˜ ëª¨ì–‘ ê´€ì°°í•˜ê¸°</title>
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .moon-image {
            width: 200px;
            height: 200px;
            background-size: contain;
            background-repeat: no-repeat;
            margin: 0 auto 15px auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ë‹¬ì˜ ëª¨ì–‘ ê´€ì°°í•˜ê¸°</h1>
    <input type="date" id="dateSelector">
    <div class="moon-display">
        <div id="moonImage" class="moon-image"></div>
        <h2 id="phaseText"></h2>
        <p id="moonMeaning"></p>
        <p id="moonKasiText"></p>
        <div id="moonTimes"></div>
        <div id="moonPosition"></div>
    </div>
</div>
<script>
function getMoonImageName(phase) {
    if (phase < 1) return "new_moon";
    if (phase < 15) return "waxing_crescent";
    if (phase < 35) return "first_quarter";
    if (phase < 45) return "waxing_gibbous";
    if (phase < 55) return "full_moon";
    if (phase < 65) return "waning_gibbous";
    if (phase < 85) return "last_quarter";
    if (phase < 99) return "waning_crescent";
    return "new_moon";
}

function getMoonPhaseMeaning(phase) {
    if (phase < 1) return ["ì‚­ (New Moon) ğŸŒ‘", "ë‹¬ì´ ì™„ì „íˆ ê°€ë ¤ì ¸ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì‹œì‘ì„ ì¤€ë¹„í•´ë³´ì„¸ìš”."];
    if (phase < 15) return ["ì´ˆìŠ¹ë‹¬ ğŸŒ’", "ìƒˆë¡œìš´ ì•„ì´ë””ì–´ì™€ ì‹œì‘ì— ì í•©í•œ ì‹œê¸°ì…ë‹ˆë‹¤."];
    if (phase < 35) return ["ìƒí˜„ë‹¬ ğŸŒ“", "ì„±ì¥ì˜ ê³¼ì • ì†ì—ì„œ ê· í˜•ì„ ë˜ì°¾ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤."];
    if (phase < 45) return ["ë§Œìƒ ğŸŒ”", "ë³´ë¦„ë‹¬ì„ í–¥í•´ ê°€ëŠ” ì™„ì„±ì˜ ê¸¸ëª©ì…ë‹ˆë‹¤."];
    if (phase < 55) return ["ë³´ë¦„ë‹¬ ğŸŒ•", "ê°€ì¥ ë°ì€ ì‹œê¸°ì…ë‹ˆë‹¤. ê°ì‚¬ì™€ ì„±ì°°ì˜ ì‹œê°„ì…ë‹ˆë‹¤."];
    if (phase < 65) return ["ê¸°ìš¸ì–´ê°€ëŠ” ë§Œìƒ ğŸŒ–", "ì´ë£¨ì–´ì§„ ê²ƒì„ ì •ë¦¬í•˜ê³  ë‚˜ëˆŒ ì‹œê¸°ì…ë‹ˆë‹¤."];
    if (phase < 85) return ["í•˜í˜„ë‹¬ ğŸŒ—", "ë°˜ì„±í•˜ê³  ë‚´ë ¤ë†“ëŠ” ì‹œê°„ì´ í•„ìš”í•©ë‹ˆë‹¤."];
    if (phase < 99) return ["ê·¸ë¯ë‹¬ ğŸŒ˜", "ëì„ ì¤€ë¹„í•˜ê³  ìƒˆë¡œìš´ ìˆœí™˜ì„ ìœ„í•œ ì‰¼ì˜ ì‹œê¸°ì…ë‹ˆë‹¤."];
    return ["ì‚­ (New Moon) ğŸŒ‘", "ë‹¬ì´ ì™„ì „íˆ ê°€ë ¤ì ¸ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤."];
}

let currentLocation = null;
function updateUI(date) {
    const moon = SunCalc.getMoonIllumination(date);
    const phase = moon.phase * 100;
    const [name, meaning] = getMoonPhaseMeaning(phase);
    const imageName = getMoonImageName(phase);

    document.getElementById('moonImage').style.backgroundImage = `url('images/${imageName}.png')`;
    document.getElementById('phaseText').textContent = name;
    document.getElementById('moonMeaning').textContent = meaning;

    // í•œêµ­ì²œë¬¸ì—°êµ¬ì› API ì—°ë™ ì˜ˆì‹œ
    fetch(`https://astro.kasi.re.kr/api/moon?date=${date.toISOString().slice(0,10)}&lat=${currentLocation?.latitude}&lon=${currentLocation?.longitude}`)
        .then(res => res.json())
        .then(data => {
            if (data) {
                document.getElementById('moonKasiText').textContent = `KASI ìœ„ìƒ: ${data.phase} (${data.phase_name})`;
            }
        })
        .catch(() => {
            document.getElementById('moonKasiText').textContent = "KASI ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        });

    if (currentLocation) {
        const moonTimes = SunCalc.getMoonTimes(date, currentLocation.latitude, currentLocation.longitude);
        const moonPos = SunCalc.getMoonPosition(date, currentLocation.latitude, currentLocation.longitude);
        document.getElementById('moonTimes').textContent = `ì¶œ: ${moonTimes.rise?.toLocaleTimeString() || 'N/A'}, ëª°: ${moonTimes.set?.toLocaleTimeString() || 'N/A'}`;
        document.getElementById('moonPosition').textContent = `ê³ ë„: ${(moonPos.altitude * 180 / Math.PI).toFixed(1)}Â°, ë°©ìœ„ê°: ${(moonPos.azimuth * 180 / Math.PI).toFixed(1)}Â°`;
    }
}

document.getElementById('dateSelector').valueAsDate = new Date();
document.getElementById('dateSelector').addEventListener('change', (e) => {
    updateUI(new Date(e.target.value));
});

navigator.geolocation.getCurrentPosition(pos => {
    currentLocation = {
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
    };
    updateUI(new Date());
}, () => {
    document.getElementById('moonPosition').textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
});
</script>
</body>
</html>
